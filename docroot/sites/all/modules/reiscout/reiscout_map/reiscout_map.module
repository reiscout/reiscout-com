<?php

/**
 * @file
 * Implements map squared data selling for points.
 *
 * ToDo:
 * check commerce_userpoints code
 * rework reiscout_points_product to make it working with commerce
 * provide transaction type to keep track points transactions
 * rework helper class as CTools plugin
 */

/* ToDo: could we use autoload instead ? */
include_once 'SellMapSquareHelper.php';

/**
 * Implements hook_reiscout_points_product_info().
 *
 * Declare a commerce product as a reiscout_points_product.
 */
function reiscout_map_reiscout_points_product_info() {
  return array(
    'individual_map_square' => array(
      'commerce_product_type' => 'individual_map_square',
      'title' => t('Buy this map square'),
      'description' => t("Gives a user an access to map square route files"),
    ),
  );
}

/**
 * Implements hook_field_access.
 */
function reiscout_map_field_access($op, $field, $entity_type, $entity, $account) {
  $helper = new SellMapSquareHelper();
  return $helper->hook_field_access($op, $field, $entity_type, $entity, $account);
}

/**
 * Implements hook_node_insert().
 */
function reiscout_map_node_insert($node) {
  $helper = new SellMapSquareHelper();
  $helper->on_entity_create($node);
}

/**
 * Implements hook_node_delete().
 *
 * @todo: delete linked 'Address Access' product if it has not yet been purchased
 */
function reiscout_map_node_delete($node) {
  $helper = new SellMapSquareHelper();
  $helper->on_entity_delete($node);
}

/**
 * Implements hook_node_view().
 */
function reiscout_map_node_view($node, $view_mode, $langcode) {
  $helper = new SellMapSquareHelper();
  if ($helper->get_entity_bundle() == $node->type && 'full' == $view_mode) {
    $form = $helper->get_product_form($node);
    $product_type = $helper->get_product_type();
    $node->content["reiscout-map-product-$product_type-form"] = $form;
  }
}
